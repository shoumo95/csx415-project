---
title: "Model Performance - linear"
author:
  - name: Hakan Egeli
  - name: Soumyendu Sarkar
date: 'April 24, 2018'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, echo=FALSE, include = FALSE}

# load the project. This will autoload the data and also create training and test datasets
library('ProjectTemplate')
load.project()

```

```{r, echo=FALSE, include=FALSE}

library(caret)

require(gridExtra)

```


## Perform some explortory data analysis.

- we looked at the dtree with all variables
- we choos the top variables
- we did iterated the dtree

- we took the same variables and reiterated out lm

- we took out the sales data to ceate an alternate model which does not depend on sales information

- Median Income and Median Income households which we obtained **census data** played a significant role

## Definitely plot (histogram) any response variables.
##Plot at your predictors.

d-tree plots

multiple univariable plots for lm

##Begin the analysis:

##For analysis/explanatory/exploratory projects start by

##For ML projects

##Build a linear model use lm for regression and/or glm( family=binomial. ... ) for classification

##Evaluate your linear model using your model evaluation RMarkdown document, if you are clever you can reuse the template and version it very quickly.

##Knit this to model-performance-linear.[html|pdf|md] where you are keeping your assets

##Make sure you know who to interpret a linear model! Let me know if we have to cover this.

##Build a tree model (rpart)

##plot the tree paying particular attention to the first few nodes, do they make sense?

##Evaluate your tree with you model evaluation RMarkdown document. Knit this to model-performance-rpart.[html|pdf|md]

##Has your model(s) met the model success criteria?


### Credit Limit vs Sales Numbers

```{r, echo=FALSE}
g1 <- ggplot() + 
  geom_point(aes(x = dataset$SalesLastYr, y = dataset$CreditLimit), color = 'blue') +
  xlab('Last Year\'s Sales') +
  ylab('Credit Limit') +
  scale_x_continuous(breaks=c(100000, 200000, 300000, 400000, 500000, 600000), labels=c("100K", "200K", "300K", "400K", "500K", "600K")) +
  scale_y_continuous(breaks=c(10000, 20000, 30000, 40000, 50000), labels=c("10K", "20K", "30K", "40K", "50K"))

g2 <- ggplot() + 
  geom_point(aes(x = dataset$SalesCurrentYr, y = dataset$CreditLimit), color = 'blue') +
  xlab('Current Year\'s Sales') + 
  ylab('Credit Limit') +
  scale_x_continuous(breaks=c(20000, 40000, 60000, 80000, 100000, 120000), labels=c("20K", "40K", "60K", "80K", "100K", "120K")) +
  scale_y_continuous(breaks=c(10000, 20000, 30000, 40000, 50000), labels=c("10K", "20K", "30K", "40K", "50K"))

g3 <- ggplot() + 
  geom_point(aes(x = dataset$TotalSalesLast12Mo, y = dataset$CreditLimit), color = 'blue') +
  xlab('Last 12 Mo\'s Sales') + 
  ylab('Credit Limit') +
  scale_x_continuous(breaks=c(100000, 200000, 300000, 400000, 500000, 600000), labels=c("100K", "200K", "300K", "400K", "500K", "600K")) +
  scale_y_continuous(breaks=c(10000, 20000, 30000, 40000, 50000), labels=c("10K", "20K", "30K", "40K", "50K"))

grid.arrange(g1, g2, g3, ncol=3)

```

### Correlation of 12 Months Sales and Major Product Category Sales

```{r, echo=FALSE}
g1 <- ggplot() + 
  geom_point(aes(x = dataset$PlainBandSalesLast12Mo, y = dataset$TotalSalesLast12Mo), color = 'blue') +
  xlab('Last 12 Mo\'s Plains $') +
  ylab('Last 12 Mo\'s $') +
  scale_x_continuous(limits=c(0, 100000), breaks=c(10000, 20000, 30000, 40000, 50000, 60000, 70000, 80000, 90000, 100000), labels=c("10K", "20K", "30K", "40K", "50K", "60K", "70K", "80K", "90K", "100K")) +
  scale_y_continuous(breaks=c(100000, 200000, 300000, 400000), labels=c("100K", "200K", "300K", "400K"))

g2 <- ggplot() + 
  geom_point(aes(x = dataset$DesignBandSalesLast12Mo, y = dataset$TotalSalesLast12Mo), color = 'blue') +
  xlab('Last 12 Mo\'s Designs $') + 
  ylab('Last 12 Mo\'s $') +
  scale_x_continuous(limits=c(0, 100000), breaks=c(10000, 20000, 30000, 40000, 50000, 60000, 70000, 80000, 90000, 100000), labels=c("10K", "20K", "30K", "40K", "50K", "60K", "70K", "80K", "90K", "100K")) +
  scale_y_continuous(breaks=c(100000, 200000, 300000, 400000), labels=c("100K", "200K", "300K", "400K"))

g3 <- ggplot() + 
  geom_point(aes(x = dataset$DiamondBandSalesLast12Mo, y = dataset$TotalSalesLast12Mo), color = 'blue') +
  xlab('Last 12 Mo\'s Diamonds $') + 
  ylab('Last 12 Mo\'s $') +
  scale_x_continuous(breaks=c(10000, 20000, 30000, 40000, 50000, 60000, 70000, 80000, 90000, 100000), labels=c("10K", "20K", "30K", "40K", "50K", "60K", "70K", "80K", "90K", "100K")) +
  scale_y_continuous(breaks=c(100000, 200000, 300000, 400000), labels=c("100K", "200K", "300K", "400K"))

g4 <- ggplot() + 
  geom_point(aes(x = dataset$AlternativeMetalSalesLast12Mo, y = dataset$TotalSalesLast12Mo), color = 'blue') +
  xlab('Last 12 Mo\'s Alt Metal $') + 
  ylab('Last 12 Mo\'s $') +
  scale_x_continuous(breaks=c(10000, 20000, 30000, 40000, 50000, 60000, 70000, 80000, 90000, 100000), labels=c("10K", "20K", "30K", "40K", "50K", "60K", "70K", "80K", "90K", "100K")) +
  scale_y_continuous(breaks=c(100000, 200000, 300000, 400000), labels=c("100K", "200K", "300K", "400K"))

grid.arrange(g1, g2, g3, g4, ncol=2)

```

### Distribution of Credit Limit

```{r, echo=FALSE}
ggplot() + 
  geom_histogram(aes(dataset$CreditLimit), bins = 40) +
  scale_x_continuous(breaks=c(5000, 10000, 15000, 20000, 30000, 40000, 50000), labels=c("5K", "10K", "15K", "20K", "30K", "40K", "50K")) +
  ggtitle('Distribution of Credit Limit') +
  xlab('Credit Limit') + 
  ylab('Distribution')
```


### Relationship Between Avg Days of Pay and Credit Limits

```{r, echo=FALSE}
ggplot(dataset, aes(x = AvgDaysOfPayCategory, y = CreditLimit, fill = AvgDaysOfPayCategory)) + 
  geom_boxplot(outlier.color = 'blue', outlier.shape = 1) +
  scale_y_log10() +
  stat_summary(fun.y = mean, geom = "point", shape = 1, size = 1, color = "white") +
  theme(legend.position = "") +
  ggtitle('Avg Days of Pay vs Credit Limit') +
  xlab('Avg Days of Pay') + 
  ylab('Credit Limit')
```

### Distribution of Credit Limit Among Avg Days of Pay

```{r, echo=FALSE}

ggplot(data = dataset, aes(x = CreditLimit)) + geom_histogram(binwidth = 2000) + facet_wrap(~AvgDaysOfPayCategory)

```

## Non-Sales Attributes and Possible Correlations

### Avg Days of Pay and Median Household Income 

```{r, echo=FALSE}
ggplot(dataset, aes(x = AvgDaysOfPayCategory, y = MedianIncomeHouseholds, color = CreditLimit)) + 
  geom_jitter() +
  stat_summary(fun.y = mean, geom = "point", shape = 1, size = 2, color = "red") +
  theme(legend.position = "") +
  ggtitle('Avg Days of Pay vs Credit Limit') +
  xlab('Avg Days of Pay') + 
  ylab('Median Income Households')
```

```{r, echo=FALSE}
g1 <- ggplot(dataset, aes(x = factor(UrbanInfluenceCode), y = dataset$TotalSalesLast12Mo, color = MetroIndicator)) + 
  geom_jitter() +
  scale_y_continuous(breaks=c(100000, 200000, 300000, 400000), labels=c("100K", "200K", "300K", "400K")) +
  stat_summary(fun.y = mean, geom = "point", shape = 1, size = 1, color = "white") +
  theme(legend.position = "") +
  ggtitle('12 Mo Sales Over Urban Influence') +
  xlab('Urban Influence Code') + 
  ylab('Total $ Last 12 Mo')

g2 <- ggplot() + 
  geom_point(aes(x = dataset$TotalPopulation, y = dataset$NumberOfJewelryStores), color = 'blue') +
  scale_x_continuous(breaks=c(5000000, 10000000, 15000000, 20000000), labels=c("5M", "10M", "15M", "20M")) +
  scale_y_continuous(breaks=c(1000, 2000, 3000, 4000, 5000), labels=c("1K", "2K", "3K", "4K", "5K")) +
  ggtitle('Corr Total Population vs # Stores') +
  xlab('Total Population') + 
  ylab('# Jewelry Stores')

grid.arrange(g1, g2, ncol=2)

```

# build a linear model using all the variables (except JBT Rating) to examine variable revelance

```{r, echo=FALSE}

model <- lm(formula = CreditLimit ~ SalesCurrentYr + SalesLastYr + PlainBandSalesLast12Mo + DesignBandSalesLast12Mo + DiamondBandSalesLast12Mo + AlternativeMetalSalesLast12Mo + TotalSalesLast12Mo + BuyingGroupMember + NumberOfStoreLocations + AvgDaysOfPayCategory + AvgDaysOfPay + MaxDaysPastDue + MaxAmtPastDue + AvgAmtPastDue + ReturnedPaymentCount + MaxReturnedPaymentAmt + RuralUrbanContinuumCode + UrbanInfluenceCode + MetroIndicator + TotalPopulation + MedianEarnings + MedianRetailTradeEarnings + TotalHouseholds + MedianIncomeHouseholds + NumberOfJewelryStores + NumberOfJewelryStoresState + JewelryStoreSalesState, data = dataset_train)

```


```{r, echo=FALSE}

summary(model)

```


# remove the intercept

```{r, echo=FALSE}

model <- lm(formula = CreditLimit ~ 1 + SalesCurrentYr + SalesLastYr + PlainBandSalesLast12Mo + DesignBandSalesLast12Mo + DiamondBandSalesLast12Mo + AlternativeMetalSalesLast12Mo + TotalSalesLast12Mo + BuyingGroupMember + NumberOfStoreLocations + AvgDaysOfPayCategory + AvgDaysOfPay + MaxDaysPastDue + MaxAmtPastDue + AvgAmtPastDue + ReturnedPaymentCount + MaxReturnedPaymentAmt + RuralUrbanContinuumCode + UrbanInfluenceCode + MetroIndicator + TotalPopulation + MedianEarnings + MedianRetailTradeEarnings + TotalHouseholds + MedianIncomeHouseholds + NumberOfJewelryStores + NumberOfJewelryStoresState + JewelryStoreSalesState - 1, data = dataset_train)

```


```{r, echo=FALSE}

summary(model)

```


# remove AvgDaysOfPayCategory

```{r, echo=FALSE}

model <- lm(formula = CreditLimit ~ 1 + SalesCurrentYr + SalesLastYr + PlainBandSalesLast12Mo + DesignBandSalesLast12Mo + DiamondBandSalesLast12Mo + AlternativeMetalSalesLast12Mo + TotalSalesLast12Mo + BuyingGroupMember + NumberOfStoreLocations + AvgDaysOfPay + MaxDaysPastDue + MaxAmtPastDue + AvgAmtPastDue + ReturnedPaymentCount + MaxReturnedPaymentAmt + RuralUrbanContinuumCode + UrbanInfluenceCode + MetroIndicator + TotalPopulation + MedianEarnings + MedianRetailTradeEarnings + TotalHouseholds + MedianIncomeHouseholds + NumberOfJewelryStores + NumberOfJewelryStoresState + JewelryStoreSalesState - 1, data = dataset_train)

```


```{r, echo=FALSE}

summary(model)

```


# remove AvgAmtPastDue

```{r, echo=FALSE}

model <- lm(formula = CreditLimit ~ 1 + SalesCurrentYr + SalesLastYr + PlainBandSalesLast12Mo + DesignBandSalesLast12Mo + DiamondBandSalesLast12Mo + AlternativeMetalSalesLast12Mo + TotalSalesLast12Mo + BuyingGroupMember + NumberOfStoreLocations + AvgDaysOfPay + MaxDaysPastDue + MaxAmtPastDue + ReturnedPaymentCount + MaxReturnedPaymentAmt + RuralUrbanContinuumCode + UrbanInfluenceCode + MetroIndicator + TotalPopulation + MedianEarnings + MedianRetailTradeEarnings + TotalHouseholds + MedianIncomeHouseholds + NumberOfJewelryStores + NumberOfJewelryStoresState + JewelryStoreSalesState - 1, data = dataset_train)

```


```{r, echo=FALSE}

summary(model)

```


# remove NumberOfJewelryStores, 
Residual standard error: 4254 on 1366 degrees of freedom
  (11 observations deleted due to missingness)
Multiple R-squared:  0.4575,	Adjusted R-squared:  0.4479 
F-statistic: 47.99 on 24 and 1366 DF,  p-value: < 2.2e-16


#then TotalPopulation, 
Residual standard error: 4252 on 1367 degrees of freedom
  (11 observations deleted due to missingness)
Multiple R-squared:  0.4574,	Adjusted R-squared:  0.4483 
F-statistic: 50.11 on 23 and 1367 DF,  p-value: < 2.2e-16

#then AlternativeMetalSalesLast12Mo, 
Residual standard error: 4251 on 1368 degrees of freedom
  (11 observations deleted due to missingness)
Multiple R-squared:  0.4574,	Adjusted R-squared:  0.4487 
F-statistic: 52.43 on 22 and 1368 DF,  p-value: < 2.2e-16

#then TotalSalesLast12Mo, 
Residual standard error: 4249 on 1369 degrees of freedom
  (11 observations deleted due to missingness)
Multiple R-squared:  0.4574,	Adjusted R-squared:  0.4491 
F-statistic: 54.96 on 21 and 1369 DF,  p-value: < 2.2e-16

#then DiamondBandSalesLast12Mo
Residual standard error: 4248 on 1370 degrees of freedom
  (11 observations deleted due to missingness)
Multiple R-squared:  0.4574,	Adjusted R-squared:  0.4495 
F-statistic: 57.75 on 20 and 1370 DF,  p-value: < 2.2e-16

#then UrbanInfluenceCode
Residual standard error: 4246 on 1371 degrees of freedom
  (11 observations deleted due to missingness)
Multiple R-squared:  0.4574,	Adjusted R-squared:  0.4499 
F-statistic: 60.83 on 19 and 1371 DF,  p-value: < 2.2e-16

#then MedianRetailTradeEarnings
Residual standard error: 4245 on 1372 degrees of freedom
  (11 observations deleted due to missingness)
Multiple R-squared:  0.4574,	Adjusted R-squared:  0.4502 
F-statistic: 64.24 on 18 and 1372 DF,  p-value: < 2.2e-16

#then MaxReturnedPaymentAmt
Residual standard error: 4244 on 1373 degrees of freedom
  (11 observations deleted due to missingness)
Multiple R-squared:  0.4573,	Adjusted R-squared:  0.4506 
F-statistic: 68.05 on 17 and 1373 DF,  p-value: < 2.2e-16

#then NumberOfJewelryStoresState
Residual standard error: 4243 on 1374 degrees of freedom
  (11 observations deleted due to missingness)
Multiple R-squared:  0.4572,	Adjusted R-squared:  0.4508 
F-statistic: 72.32 on 16 and 1374 DF,  p-value: < 2.2e-16

#then JewelryStoreSalesState
Residual standard error: 4242 on 1375 degrees of freedom
  (11 observations deleted due to missingness)
Multiple R-squared:  0.4571,	Adjusted R-squared:  0.4511 
F-statistic: 77.17 on 15 and 1375 DF,  p-value: < 2.2e-16

#then MaxAmtPastDue
Residual standard error: 4241 on 1376 degrees of freedom
  (11 observations deleted due to missingness)
Multiple R-squared:  0.4569,	Adjusted R-squared:  0.4514 
F-statistic: 82.69 on 14 and 1376 DF,  p-value: < 2.2e-16

#then NumberOfStoreLocations
Residual standard error: 4240 on 1377 degrees of freedom
  (11 observations deleted due to missingness)
Multiple R-squared:  0.4567,	Adjusted R-squared:  0.4516 
F-statistic: 89.03 on 13 and 1377 DF,  p-value: < 2.2e-16

#then BuyingGroupMember
Residual standard error: 4239 on 1378 degrees of freedom
  (11 observations deleted due to missingness)
Multiple R-squared:  0.4564,	Adjusted R-squared:  0.4517 
F-statistic: 96.42 on 12 and 1378 DF,  p-value: < 2.2e-16

#then ReturnedPaymentCount
Residual standard error: 4240 on 1379 degrees of freedom
  (11 observations deleted due to missingness)
Multiple R-squared:  0.456,	Adjusted R-squared:  0.4517 
F-statistic: 105.1 on 11 and 1379 DF,  p-value: < 2.2e-16

#then MaxDaysPastDue
Residual standard error: 4240 on 1380 degrees of freedom
  (11 observations deleted due to missingness)
Multiple R-squared:  0.4555,	Adjusted R-squared:  0.4516 
F-statistic: 115.4 on 10 and 1380 DF,  p-value: < 2.2e-16

# added MaxDaysPastDue back


```{r, echo=FALSE}

model <- lm(formula = CreditLimit ~ SalesCurrentYr + SalesLastYr + PlainBandSalesLast12Mo + DesignBandSalesLast12Mo + AvgDaysOfPay + RuralUrbanContinuumCode + MetroIndicator + MedianEarnings + TotalHouseholds + MedianIncomeHouseholds + MaxDaysPastDue - 1, data = dataset_train)

```


```{r, echo=FALSE}

summary(model)

```


# build a linear model using the same relevant variables which we have initially used in our decision tree

```{r, echo=FALSE}

model <- lm(formula = CreditLimit ~ DesignBandSalesLast12Mo + AvgDaysOfPay + SalesLastYr + TotalSalesLast12Mo + AlternativeMetalSalesLast12Mo + MedianIncomeHouseholds + SalesCurrentYr + PlainBandSalesLast12Mo + MedianEarnings + RuralUrbanContinuumCode, data = dataset_train)

```


```{r, echo=FALSE}

summary(model)

```

# examine a variation of a linear model using non-sales variables

```{r, echo=FALSE}

model <- lm(formula = CreditLimit ~ AvgDaysOfPay + MedianIncomeHouseholds + SalesCurrentYr + MedianEarnings, data = dataset_train)

```


```{r, echo=FALSE}

summary(model)

```


# linear models using different "family" parameters

```{r, echo=FALSE}

model <- glm(CreditLimit ~ SalesCurrentYr + SalesLastYr + PlainBandSalesLast12Mo + DesignBandSalesLast12Mo + AvgDaysOfPay + RuralUrbanContinuumCode + MetroIndicator + MedianEarnings + TotalHouseholds + MedianIncomeHouseholds + MaxDaysPastDue - 1, family = gaussian, data=dataset_train)


```


```{r, echo=FALSE}

summary(model)

```

```{r, echo=FALSE}

model <- glm(CreditLimit ~ SalesCurrentYr + SalesLastYr + PlainBandSalesLast12Mo + DesignBandSalesLast12Mo + AvgDaysOfPay + RuralUrbanContinuumCode + MetroIndicator + MedianEarnings + TotalHouseholds + MedianIncomeHouseholds + MaxDaysPastDue - 1, family = poisson, data=dataset_train)


```


```{r, echo=FALSE}

summary(model)

```


# how do these models compare to each other and to the first "naive" model?

```{r, echo=FALSE}

predictions <- predict(model, dataset_train)

summary(predictions)

```






